<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>soma_workflow.client_types &#8212; soma-workflow version 3.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=def86cc0" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    
    <script src="../../_static/documentation_options.js?v=3eb8911e"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/icon_small.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">soma-workflow version 3.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">soma_workflow.client_types</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for soma_workflow.client_types</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">author: Soizic Laguitton</span>

<span class="sd">organization: I2BM, Neurospin, Gif-sur-Yvette, France</span>
<span class="sd">organization: CATI, France</span>
<span class="sd">organization: U{IFR 49</span>

<span class="sd">license: CeCILL version: 2 http://www.cecill.info/licences/Licence_CeCILL_V2-en.html</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Imports</span>
<span class="c1">#-------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">soma_workflow.constants</span> <span class="k">as</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="c1"># python2/3 compatibility</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Classes and functions</span>
<span class="c1">#-------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Job representation.</span>

<span class="sd">    .. note::</span>
<span class="sd">      The command is the only argument required to create a Job.</span>
<span class="sd">      It is also useful to fill the job name for the workflow display in the GUI.</span>

<span class="sd">    **Parallel jobs**</span>

<span class="sd">    When a job is designed to run on multiple processors, cluster managements systems normally do the necessary work to run or duplicate the job processes on multiple computing nodes. There are basically 3 classical ways to do it:</span>

<span class="sd">      * use MPI (whatever implementation): job commands are run through a launcher program (``mpirun``) which will run the processes and establish inter-process communications.</span>
<span class="sd">      * use OpenMP: this threading-based system allows to use several cores on the same computing node (using shared memory). The OpenMP allows to use the required nuber of threads.</span>
<span class="sd">      * manual threading or forking (&quot;native&quot; mode).</span>

<span class="sd">    In all cases one job runs on several processors/cores. The MPI variant additionally allows to run the same job on several computing nodes (which do not share memory), the others should run on the same node (as far as I know - I&#39;m not an expert of OpenMP). The job specifications should then precise which kind of parallelism they are using, the number of nodes the job should run on, and the number of CPU cores which should be allocated on each node. Thus the **parallel_job_info** variable of a job is a dictionary giving these 3 information, under the respective keys `config_name`, `nodes_number` and `cpu_per_node`. In OpenMP and native modes, the nodes_number should be 1.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    command: sequence of string or/and FileTransfer or/and SharedResourcePath or/and TemporaryPath or/and tuple (FileTransfer, relative_path) or/and sequence of FileTransfer or/and sequence of SharedResourcePath or/and sequence of tuple (FileTransfer, relative_path)</span>
<span class="sd">        The command to execute. It can not be empty. In case of a shared file system</span>
<span class="sd">        the command is a sequence of string.</span>

<span class="sd">        In the other cases, the FileTransfer, SharedResourcePath, and TemporaryPath</span>
<span class="sd">        objects will be replaced by the appropriate path before the job execution.</span>

<span class="sd">        The tuples (FileTransfer, relative_path) can be used to refer to a file in a</span>
<span class="sd">        transfered directory.</span>

<span class="sd">        The sequences of FileTransfer, SharedResourcePath or tuple (FileTransfer,</span>
<span class="sd">        relative_path) will be replaced by the string &quot;[&#39;path1&#39;, &#39;path2&#39;, &#39;path3&#39;]&quot;</span>
<span class="sd">        before the job execution. The FileTransfer, SharedResourcePath or tuple</span>
<span class="sd">        (FileTransfer, relative_path) are replaced by the appropriate path inside</span>
<span class="sd">        the sequence.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of the Job which will be displayed in the GUI</span>

<span class="sd">    referenced_input_files: sequence of SpecialPath (FileTransfer, TemporaryPath...)</span>
<span class="sd">        List of the FileTransfer which are input of the Job. In other words,</span>
<span class="sd">        FileTransfer which are requiered by the Job to run. It includes the</span>
<span class="sd">        stdin if you use one.</span>

<span class="sd">    referenced_output_files: sequence of SpecialPath (FileTransfer, TemporaryPath...)</span>
<span class="sd">        List of the FileTransfer which are output of the Job. In other words,</span>
<span class="sd">        the FileTransfer which will be created or modified by the Job.</span>

<span class="sd">    stdin: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path to the file which will be read as input stream by the Job.</span>

<span class="sd">    join_stderrout: boolean</span>
<span class="sd">        Specifies whether the error stream should be mixed with the output stream.</span>

<span class="sd">    stdout_file: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path of the file where the standard output stream of the job will be</span>
<span class="sd">        redirected.</span>

<span class="sd">    stderr_file: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path of the file where the standard error stream of the job will be</span>
<span class="sd">        redirected.</span>

<span class="sd">        .. note::</span>
<span class="sd">          Set stdout_file and stderr_file only if you need to redirect the</span>
<span class="sd">          standard output to a specific file. Indeed, even if they are not set</span>
<span class="sd">          the standard outputs will always be available through the</span>
<span class="sd">          WorklfowController API.</span>

<span class="sd">    working_directory: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path of the directory where the job will be executed. The working directory</span>
<span class="sd">        is useful if your Job uses relative file path for example.</span>

<span class="sd">    priority: int</span>
<span class="sd">        Job priority: 0 = low priority. If several Jobs are ready to run at the</span>
<span class="sd">        same time the jobs with higher priority will be submitted first.</span>

<span class="sd">    native_specification: string</span>
<span class="sd">        Some specific option/function of the computing resource you want to use</span>
<span class="sd">        might not be available among the list of Soma-workflow Job attributes.</span>
<span class="sd">        Use the native specification attribute to use these specific functionalities.</span>
<span class="sd">        If a native_specification is defined here, the configured native</span>
<span class="sd">        specification will be ignored (documentation configuration item: NATIVE_SPECIFICATION).</span>

<span class="sd">        *Example:* Specification of a job walltime and more:</span>

<span class="sd">        * using a PBS cluster: native_specification=&quot;-l walltime=10:00:00,pmem=16gb&quot;</span>
<span class="sd">        * using a SGE cluster: native_specification=&quot;-l h_rt=10:00:00&quot;</span>

<span class="sd">    parallel_job_info: dict</span>
<span class="sd">        The parallel job information must be set if the Job is parallel (ie. made to</span>
<span class="sd">        run on several CPU).</span>
<span class="sd">        The parallel job information is a dict, with the following supported items:</span>

<span class="sd">        * config_name: name of the configuration (native, MPI, OpenMP)</span>
<span class="sd">        * nodes_number: number of computing nodes used by the Job,</span>
<span class="sd">        * cpu_per_node: number of CPU or cores needed for each node</span>

<span class="sd">        The configuration name is the type of parallel Job. Example: MPI or OpenMP.</span>

<span class="sd">        .. warning::</span>
<span class="sd">          The computing resources must be configured explicitly to use this feature.</span>

<span class="sd">    user_storage: picklable object</span>
<span class="sd">        Should have been any small and picklable object for user need but was never</span>
<span class="sd">        fully implemented. This parameter is simply ignored.</span>

<span class="sd">    env: dict(string, string)</span>
<span class="sd">        Environment variables to use when the job gets executed.</span>

<span class="sd">    param_dict: dict</span>
<span class="sd">        New in 3.1.</span>
<span class="sd">        Optional dictionary for job &quot;parameters values&quot;. In case of dynamic</span>
<span class="sd">        outputs from a job, downstream jobjs values have to be set accordingly</span>
<span class="sd">        during the workflow execution. Thus we must be able to know how to</span>
<span class="sd">        replace the parameters values in the commandline. To do so, jobs should</span>
<span class="sd">        provide commandlines not with builtin values, but with replacement</span>
<span class="sd">        strings, and a dict of parameters with names::</span>

<span class="sd">            command = [&#39;cp&#39;, &#39;%(source)s&#39;, &#39;%(dest)s&#39;]</span>
<span class="sd">            param_dict = {&#39;source&#39;: &#39;/data/file1.txt&#39;,</span>
<span class="sd">                          &#39;dest&#39;: &#39;/data/file2.txt&#39;}</span>

<span class="sd">        Parameters names can be linked in the workflow to some other jobs</span>
<span class="sd">        outputs.</span>

<span class="sd">    use_input_params_file: bool</span>
<span class="sd">        if True, input parameters from the param_dict will not be passed using</span>
<span class="sd">        substitutions in the commandline, but through a JSON file.</span>

<span class="sd">    has_outputs: bool</span>
<span class="sd">        New in 3.1.</span>
<span class="sd">        Set if the job will write a special JSON file which contains output</span>
<span class="sd">        parameters values, when the job is a process with outputs.</span>

<span class="sd">    input_params_file: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path to the file which will contain input parameters of the</span>
<span class="sd">        job.</span>

<span class="sd">    output_params_file: string or FileTransfer or SharedResourcePath</span>
<span class="sd">        Path to the file which will be written for output parameters of the</span>
<span class="sd">        job.</span>

<span class="sd">    disposal_timeout: int</span>
<span class="sd">        Only requiered outside of a workflow</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># sequence of sequence of string or/and FileTransfer or/and</span>
    <span class="c1"># SharedResourcePath or/and tuple (relative_path, FileTransfer) or/and</span>
    <span class="c1"># sequence of FileTransfer or/and sequence of SharedResourcePath or/and</span>
    <span class="c1"># sequence of tuple (relative_path, FileTransfers.)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of FileTransfer</span>
    <span class="n">referenced_input_files</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of FileTransfer</span>
    <span class="n">referenced_output_files</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string (path)</span>
    <span class="n">stdin</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># boolean</span>
    <span class="n">join_stderrout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string (path)</span>
    <span class="n">stdout_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string (path)</span>
    <span class="n">stderr_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string (path)</span>
    <span class="n">working_directory</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># int</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string</span>
    <span class="n">native_specification</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># tuple(string, int)</span>
    <span class="n">parallel_job_info</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># int (in hours)</span>
    <span class="n">disposal_timeout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># any small and picklable object needed by the user</span>
    <span class="n">user_storage</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># dict (name -&gt; value)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># dict (dst_job -&gt; dict(dst_param_name: (src_job, src_param_name))</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># bool</span>
    <span class="n">use_input_params_file</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># bool</span>
    <span class="n">has_outputs</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># string (path)</span>
    <span class="n">input_params_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string (path)</span>
    <span class="n">output_params_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># dict (config options)</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">command</span><span class="p">,</span>
                 <span class="n">referenced_input_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">referenced_output_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stdin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">join_stderrout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">disposal_timeout</span><span class="o">=</span><span class="mi">168</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stdout_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stderr_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">working_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">parallel_job_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">native_specification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">user_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">param_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">use_input_params_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">has_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">input_params_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">output_params_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">configuration</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="k">if</span> <span class="n">referenced_input_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span> <span class="o">=</span> <span class="n">referenced_input_files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">referenced_output_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span> <span class="o">=</span> <span class="n">referenced_output_files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_stderrout</span> <span class="o">=</span> <span class="n">join_stderrout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disposal_timeout</span> <span class="o">=</span> <span class="n">disposal_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_file</span> <span class="o">=</span> <span class="n">stdout_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">stderr_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">working_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_job_info</span> <span class="o">=</span> <span class="n">parallel_job_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">native_specification</span> <span class="o">=</span> <span class="n">native_specification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span> <span class="o">=</span> <span class="n">param_dict</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_input_params_file</span> <span class="o">=</span> <span class="n">use_input_params_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_outputs</span> <span class="o">=</span> <span class="n">has_outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_params_file</span> <span class="o">=</span> <span class="n">input_params_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_params_file</span> <span class="o">=</span> <span class="n">output_params_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">configuration</span>

        <span class="c1"># this deson&#39;t seem to be really hamful.</span>
        <span class="c1"># for command_elem in self.command:</span>
        <span class="c1">#     if isinstance(command_elem, six.string_types):</span>
        <span class="c1">#         if &quot;&#39;&quot; in command_elem:</span>
        <span class="c1">#             warnings.warn(&quot;%s contains single quote. It could fail using DRMAA&quot;</span>
        <span class="c1">#                           % command_elem, UserWarning)</span>

    <span class="k">def</span> <span class="nf">_attributes_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">other_element</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other_element</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="c1"># special case str / unicode</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="c1"># print(&#39;differ in class:&#39;, element.__class__,</span>
                <span class="c1"># other_element.__class__)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">FileTransfer</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">SharedResourcePath</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">TemporaryPath</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">OptionPath</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">element</span><span class="o">.</span><span class="n">attributs_equal</span><span class="p">(</span><span class="n">other_element</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_element</span><span class="p">):</span>
                <span class="c1"># print(&#39;len differ:&#39;, len(element), &#39;!=&#39;, len(other_element))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_equal</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">other_element</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="c1"># print(&#39;list element differ:&#39;, element[i], &#39;!=&#39;,</span>
                    <span class="c1"># other_element[i])</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other_element</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
                <span class="n">other_item</span> <span class="o">=</span> <span class="n">other_element</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_equal</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">other_item</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">element</span> <span class="o">==</span> <span class="n">other_element</span>

    <span class="k">def</span> <span class="nf">get_commandline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandline_repl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commandline_repl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get &quot;processed&quot; commandline list. Each element in the commandline list</span>
<span class="sd">        which contains a replacement string in the shame %(var)s is replaced</span>
<span class="sd">        using the param_dict values.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># return [x % self.param_dict for x in self.command]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">command</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;%\((.+)\)[dsf]&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commandline_repl</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)s&#39;</span> <span class="o">%</span> <span class="n">var</span>
                    <span class="n">m</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="c1"># if m[0] == &#39;&#39;:</span>
                            <span class="c1"># m = m[1:]</span>
                        <span class="c1"># if m[-1] == &#39;&#39;:</span>
                            <span class="c1"># m = m[:-1]</span>
                        <span class="c1"># WARNING: returns a string, losing</span>
                        <span class="c1"># SpecialPath instances</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># TODO a better solution would be to overload __eq__ and __neq__ operator</span>
        <span class="c1"># however these operators are used in soma-workflow to test if</span>
        <span class="c1"># two objects are the same instance. These tests have to be replaced</span>
        <span class="c1"># first using the id python function.</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;input_params_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_outputs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stdin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;join_stderrout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stdout_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stderr_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;working_directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">,</span>
            <span class="s2">&quot;native_specification&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parallel_job_info&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;env&quot;</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">,</span>
            <span class="s2">&quot;referenced_input_files&quot;</span><span class="p">,</span>
            <span class="s2">&quot;referenced_output_files&quot;</span><span class="p">,</span>
            <span class="s2">&quot;param_dict&quot;</span><span class="p">,</span>
            <span class="s2">&quot;input_params_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;output_params_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_equal</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">other_attr</span><span class="p">):</span>
                <span class="c1"># print(&#39;differ in:&#39;, attr_name)</span>
                <span class="c1"># print(attr, &#39;!=&#39;, other_attr)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                  <span class="n">d</span><span class="p">,</span>
                  <span class="n">tr_from_ids</span><span class="p">,</span>
                  <span class="n">srp_from_ids</span><span class="p">,</span>
                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                  <span class="n">opt_from_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         * d *dictionary*</span>
<span class="sd">         * tr_from_id *id -&gt; FileTransfer*</span>
<span class="sd">         * srp_from_id *id -&gt; SharedResourcePath*</span>
<span class="sd">         * tmp_from_ids *id -&gt; TemporaryPath*</span>
<span class="sd">         * opt_from_ids *id -&gt; OptionPath*</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">],</span>
                  <span class="n">configuration</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configuration&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">new_command</span> <span class="o">=</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                                             <span class="n">tr_from_ids</span><span class="p">,</span>
                                             <span class="n">srp_from_ids</span><span class="p">,</span>
                                             <span class="n">tmp_from_ids</span><span class="p">,</span>
                                             <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">new_command</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">:</span>
            <span class="n">ref_in_files</span> <span class="o">=</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">,</span>
                                                  <span class="n">tr_from_ids</span><span class="p">,</span>
                                                  <span class="n">srp_from_ids</span><span class="p">,</span>
                                                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                  <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span> <span class="o">=</span> <span class="n">ref_in_files</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">:</span>
            <span class="n">ref_out_files</span> <span class="o">=</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">,</span>
                                                   <span class="n">tr_from_ids</span><span class="p">,</span>
                                                   <span class="n">srp_from_ids</span><span class="p">,</span>
                                                   <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                   <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span> <span class="o">=</span> <span class="n">ref_out_files</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                                          <span class="n">tr_from_ids</span><span class="p">,</span>
                                          <span class="n">srp_from_ids</span><span class="p">,</span>
                                          <span class="n">tmp_from_ids</span><span class="p">,</span>
                                          <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">stdout_file</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">stdout_file</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">stdout_file</span><span class="p">,</span>
                                                <span class="n">tr_from_ids</span><span class="p">,</span>
                                                <span class="n">srp_from_ids</span><span class="p">,</span>
                                                <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">,</span>
                                                <span class="n">tr_from_ids</span><span class="p">,</span>
                                                <span class="n">srp_from_ids</span><span class="p">,</span>
                                                <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">working_directory</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                                                      <span class="n">tr_from_ids</span><span class="p">,</span>
                                                      <span class="n">srp_from_ids</span><span class="p">,</span>
                                                      <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                      <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">output_params_file</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">output_params_file</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output_params_file</span><span class="p">,</span>
                                                       <span class="n">tr_from_ids</span><span class="p">,</span>
                                                       <span class="n">srp_from_ids</span><span class="p">,</span>
                                                       <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                       <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;param_dict&#39;</span><span class="p">,</span> <span class="p">{})):</span>
            <span class="n">job</span><span class="o">.</span><span class="n">param_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span>
                                                  <span class="n">srp_from_ids</span><span class="p">,</span>
                                                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                  <span class="n">opt_from_ids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        * id_generator *IdGenerator*</span>
<span class="sd">        * transfer_ids *dict: client.FileTransfer -&gt; int*</span>
<span class="sd">            This dictonary will be modified.</span>
<span class="sd">        * shared_res_path_id *dict: client.SharedResourcePath -&gt; int*</span>
<span class="sd">            This dictonary will be modified.</span>
<span class="sd">        * tmp_ids *dict: client.TemporaryPath -&gt; int*</span>
<span class="sd">        * opt_ids *dict: client.OptionPath -&gt; int*</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">job_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;join_stderrout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">,</span>
            <span class="s2">&quot;native_specification&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parallel_job_info&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;env&quot;</span><span class="p">,</span>
            <span class="s2">&quot;use_input_params_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_outputs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">job_dict</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
                <span class="n">job_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="c1"># command, referenced_input_files, referenced_output_files</span>
        <span class="c1"># stdin, stdout_file, stderr_file and working_directory</span>
        <span class="c1"># can contain FileTransfer et SharedResourcePath.</span>

        <span class="n">ser_command</span> <span class="o">=</span> <span class="n">list_to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                                           <span class="n">id_generator</span><span class="p">,</span>
                                           <span class="n">transfer_ids</span><span class="p">,</span>
                                           <span class="n">shared_res_path_id</span><span class="p">,</span>
                                           <span class="n">tmp_ids</span><span class="p">,</span>
                                           <span class="n">opt_ids</span><span class="p">)</span>

        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_command</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">:</span>
            <span class="n">ser_ref_in_files</span> <span class="o">=</span> <span class="n">list_to_serializable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">)</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;referenced_input_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_ref_in_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">:</span>
            <span class="n">ser_ref_out_files</span> <span class="o">=</span> <span class="n">list_to_serializable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">)</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;referenced_output_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_ref_out_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;stdin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                                                <span class="n">id_generator</span><span class="p">,</span>
                                                <span class="n">transfer_ids</span><span class="p">,</span>
                                                <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                <span class="n">tmp_ids</span><span class="p">,</span>
                                                <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout_file</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;stdout_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout_file</span><span class="p">,</span>
                                                      <span class="n">id_generator</span><span class="p">,</span>
                                                      <span class="n">transfer_ids</span><span class="p">,</span>
                                                      <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                      <span class="n">tmp_ids</span><span class="p">,</span>
                                                      <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;stderr_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="p">,</span>
                                                      <span class="n">id_generator</span><span class="p">,</span>
                                                      <span class="n">transfer_ids</span><span class="p">,</span>
                                                      <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                      <span class="n">tmp_ids</span><span class="p">,</span>
                                                      <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_params_file</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;input_params_file&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params_file</span><span class="p">,</span>
                                  <span class="n">id_generator</span><span class="p">,</span>
                                  <span class="n">transfer_ids</span><span class="p">,</span>
                                  <span class="n">shared_res_path_id</span><span class="p">,</span>
                                  <span class="n">tmp_ids</span><span class="p">,</span>
                                  <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_params_file</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;output_params_file&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_params_file</span><span class="p">,</span>
                                  <span class="n">id_generator</span><span class="p">,</span>
                                  <span class="n">transfer_ids</span><span class="p">,</span>
                                  <span class="n">shared_res_path_id</span><span class="p">,</span>
                                  <span class="n">tmp_ids</span><span class="p">,</span>
                                  <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span>
                <span class="s1">&#39;working_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="p">,</span>
                                                       <span class="n">id_generator</span><span class="p">,</span>
                                                       <span class="n">transfer_ids</span><span class="p">,</span>
                                                       <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                       <span class="n">tmp_ids</span><span class="p">,</span>
                                                       <span class="n">opt_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span><span class="p">:</span>
            <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span><span class="p">):</span>
                <span class="n">param_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">id_generator</span><span class="p">,</span>
                                                <span class="n">transfer_ids</span><span class="p">,</span>
                                                <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                <span class="n">tmp_ids</span><span class="p">,</span>
                                                <span class="n">opt_ids</span><span class="p">)</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;param_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span>

        <span class="k">return</span> <span class="n">job_dict</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># filter out some instance attributes which should / can not be pickled</span>
        <span class="n">no_picke</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_do_not_pickle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_picke</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_dict</span>
        <span class="n">copied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">no_picke</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">copied</span><span class="p">:</span>
                    <span class="n">state_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
                    <span class="n">copied</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state_dict</span>


<span class="k">class</span> <span class="nc">EngineExecutionJob</span><span class="p">(</span><span class="n">Job</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    EngineExecutionJob: a lightweight job which will not run as a &quot;real&quot; job,</span>
<span class="sd">    but as a python function, on the engine server side.</span>

<span class="sd">    Such jobs are meant to perform fast, simple operations on their inputs in</span>
<span class="sd">    order to produce modified inputs for other downstream jobs, such as string</span>
<span class="sd">    substituitons, lists manipulations, etc. As they will run in the engine</span>
<span class="sd">    process (generally the jobs submission machine) they should not perform</span>
<span class="sd">    expensive processing (CPU or memory-consuming).</span>

<span class="sd">    They are an alternative to link functions in Workflows.</span>

<span class="sd">    The only method an EngineExecutionJob defines is :meth:`engine_execution`,</span>
<span class="sd">    which will be able to use its parameters dict (as defined in its param_dict</span>
<span class="sd">    as any other job), and will return an output parameters dict.</span>

<span class="sd">    Warning: the :meth:`engine_execution` is actually a **class method**, not a</span>
<span class="sd">    regular instance method. The reason for this is that it will be used with</span>
<span class="sd">    an :class:`~soma_workflow.engine_types.EngineJob` instance, which inherits</span>
<span class="sd">    :class:`Job`, but not the exact subclass. Thus in the method, ``self`` is</span>
<span class="sd">    not a real instance of the class.</span>

<span class="sd">    The default implementation just passes its input parameters as outputs in</span>
<span class="sd">    order to allow later jobs to reuse their parameters. Subclasses define</span>
<span class="sd">    their own :meth:`engine_execution` methods.</span>

<span class="sd">    See :ref:`engine_execution_job` for more details.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">engine_execution</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dict</span>


<span class="k">class</span> <span class="nc">BarrierJob</span><span class="p">(</span><span class="n">EngineExecutionJob</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Barrier job: it is a &quot;fake&quot; job which does nothing (and will not become a</span>
<span class="sd">    real job on the DRMS) but has dependencies.</span>
<span class="sd">    It may be used to make a dependencies hub, to avoid too many dependencies</span>
<span class="sd">    with fully connected jobs sets.</span>

<span class="sd">    BarrierJob is implemented as an EngineExecutionJob, and just differs in its</span>
<span class="sd">    name, as its :meth:`~EngineExecutionJob.engine_execution` method does</span>
<span class="sd">    nothing.</span>

<span class="sd">    Ex:</span>
<span class="sd">      (Job1, Job2, Job3) should be all connected to (Job4, Job5, Job6)</span>
<span class="sd">      needs 3*3 = 9 (N^2) dependencies.</span>
<span class="sd">      With a barrier: ::</span>

<span class="sd">        Job1              Job4</span>
<span class="sd">              \         /</span>
<span class="sd">        Job2 -- Barrier -- Job5</span>
<span class="sd">              /         \.</span>
<span class="sd">        Job3              Job6</span>

<span class="sd">      needs 6 (2*N).</span>

<span class="sd">    BarrierJob constructor accepts only a subset of Job constructor parameter:</span>

<span class="sd">    **referenced_input_files**</span>

<span class="sd">    **referenced_output_files**</span>

<span class="sd">    **name**</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">command</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">referenced_input_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">referenced_output_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BarrierJob</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="p">[],</span>
                                         <span class="n">referenced_input_files</span><span class="o">=</span><span class="n">referenced_input_files</span><span class="p">,</span>
                                         <span class="n">referenced_output_files</span><span class="o">=</span><span class="n">referenced_output_files</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                  <span class="n">d</span><span class="p">,</span>
                  <span class="n">tr_from_ids</span><span class="p">,</span>
                  <span class="n">srp_from_ids</span><span class="p">,</span>
                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                  <span class="n">opt_from_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         * d *dictionary*</span>
<span class="sd">         * tr_from_id *id -&gt; FileTransfer*</span>
<span class="sd">         * srp_from_id *id -&gt; SharedResourcePath*</span>
<span class="sd">         * tmp_from_ids *id -&gt; TemporaryPath*</span>
<span class="sd">         * opt_from_ids *id -&gt; OptionPath*</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">:</span>
            <span class="n">ref_in_files</span> <span class="o">=</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">,</span>
                                                  <span class="n">tr_from_ids</span><span class="p">,</span>
                                                  <span class="n">srp_from_ids</span><span class="p">,</span>
                                                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                  <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">referenced_input_files</span> <span class="o">=</span> <span class="n">ref_in_files</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">:</span>
            <span class="n">ref_out_files</span> <span class="o">=</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">,</span>
                                                   <span class="n">tr_from_ids</span><span class="p">,</span>
                                                   <span class="n">srp_from_ids</span><span class="p">,</span>
                                                   <span class="n">tmp_from_ids</span><span class="p">,</span>
                                                   <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">referenced_output_files</span> <span class="o">=</span> <span class="n">ref_out_files</span>

        <span class="k">return</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        * id_generator *IdGenerator*</span>
<span class="sd">        * transfer_ids *dict: client.FileTransfer -&gt; int*</span>
<span class="sd">            This dictonary will be modified.</span>
<span class="sd">        * shared_res_path_id *dict: client.SharedResourcePath -&gt; int*</span>
<span class="sd">            This dictonary will be modified.</span>
<span class="sd">        * tmp_ids *dict: client.TemporaryPath -&gt; int*</span>
<span class="sd">        * opt_ids *dict: client.OptionPath -&gt; int*</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">job_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="c1"># referenced_input_files, referenced_output_files</span>
        <span class="c1"># stdin, stdout_file, stderr_file and working_directory</span>
        <span class="c1"># can contain FileTransfer et SharedResourcePath.</span>

        <span class="n">job_dict</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">:</span>
            <span class="n">ser_ref_in_files</span> <span class="o">=</span> <span class="n">list_to_serializable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_input_files</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">)</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;referenced_input_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_ref_in_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">:</span>
            <span class="n">ser_ref_out_files</span> <span class="o">=</span> <span class="n">list_to_serializable</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">referenced_output_files</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">)</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;referenced_output_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_ref_out_files</span>

        <span class="k">return</span> <span class="n">job_dict</span>


<div class="viewcode-block" id="Workflow">
<a class="viewcode-back" href="../../workflow_creation.html#client.Workflow">[docs]</a>
<span class="k">class</span> <span class="nc">Workflow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Workflow representation.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string</span>
<span class="sd">        Name of the workflow which will be displayed in the GUI.</span>
<span class="sd">        Default: workflow_id once submitted</span>

<span class="sd">    jobs: sequence of Job</span>
<span class="sd">        Workflow jobs.</span>

<span class="sd">    dependencies: sequence of tuple (element, element), element being Job or Group</span>
<span class="sd">        Dependencies between the jobs of the workflow.</span>
<span class="sd">        If a job_a needs to be executed before a job_b can run: the tuple</span>
<span class="sd">        (job_a, job_b) must be added to the workflow dependencies. job_a and job_b</span>
<span class="sd">        must belong to workflow.jobs.</span>

<span class="sd">        In Soma-Workflow 2.7 or higher, dependencies may use groups. In this case,</span>
<span class="sd">        dependencies are replaced internally to setup the groups jobs dependencies.</span>
<span class="sd">        2 additional barrier jobs (see BarrierJob) are used for each group.</span>

<span class="sd">    root_group: *sequence of Job and/or Group*</span>
<span class="sd">        Recursive description of the workflow hierarchical structure. For displaying</span>
<span class="sd">        purpose only.</span>

<span class="sd">        .. note::</span>
<span class="sd">          root_group is only used to display nicely the workflow in the GUI. It</span>
<span class="sd">          does not have any impact on the workflow execution.</span>

<span class="sd">          If root_group is not set, all the jobs of the workflow will be</span>
<span class="sd">          displayed at the root level in the GUI tree view.</span>

<span class="sd">    user_storage: picklable object</span>
<span class="sd">        For the user needs, any small and picklable object can be stored here.</span>

<span class="sd">    env: dict(string, string)</span>
<span class="sd">        Environment variables to use when the job gets executed. The workflow-</span>
<span class="sd">        level env variables are set to all jobs.</span>

<span class="sd">    env_builder_code: string</span>
<span class="sd">        python source code. This code will be executed from the engine, on</span>
<span class="sd">        server side, but not in a processing node (in a separate python process</span>
<span class="sd">        in order not to pollute the engine process) when a workflow is</span>
<span class="sd">        starting. The code should print on the standard output a json</span>
<span class="sd">        dictionary of environment variables, which will be set into all jobs,</span>
<span class="sd">        in addition to the *env* variable above.</span>

<span class="sd">    param_links: dict</span>
<span class="sd">        New in 3.1.</span>
<span class="sd">        Job parameters links. Links are in the following shape::</span>

<span class="sd">            dest_job: {dest_param: [(source_job, param, &lt;function&gt;), ...]}</span>

<span class="sd">        Links are used to get output values from jobs which have completed</span>
<span class="sd">        their run, and to set them into downstream jobs inputs. This system</span>
<span class="sd">        allows &quot;dynamic outputs&quot; in workflows.</span>
<span class="sd">        The optional function item is the name of a function that will be</span>
<span class="sd">        called to transform values from the source to the destination of the</span>
<span class="sd">        link at runtime. It is basically a string &quot;module.function&quot;, or a</span>
<span class="sd">        tuple for passing some arguments (as in partial):</span>
<span class="sd">        (&quot;module.function&quot;, 12, &quot;param&quot;). The function is called with</span>
<span class="sd">        additional arguments: parameter name, parameter value, destination</span>
<span class="sd">        parameter name, destination parameter current value. The destination</span>
<span class="sd">        parameter value is typically used to build / update a list in the</span>
<span class="sd">        destination job from a series of values in source jobs.</span>

<span class="sd">        See :ref:`params_link_functions` for details.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># string</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of Job</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of tuple (Job, Job)</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of Job and/or Group</span>
    <span class="n">root_group</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of Groups built from the root_group</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># any small and picklable object needed by the user</span>
    <span class="n">user_storage</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># environment variables</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># environment builder code</span>
    <span class="n">env_builder_code</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">param_links</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">jobs</span><span class="p">,</span>
                 <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">root_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disposal_timeout</span><span class="o">=</span><span class="mi">168</span><span class="p">,</span>
                 <span class="n">user_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">env</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">env_builder_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">param_links</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        In Soma-Workflow 3.1, some &quot;jobs outputs&quot; have been added. This concept</span>
<span class="sd">        is somewhat contradictory with the commandline execution model, which</span>
<span class="sd">        basically does not produce outputs other than files. To handle this,</span>
<span class="sd">        jobs which actually produce &quot;outputs&quot; (names parameters with output</span>
<span class="sd">        values) should write a JSON file containing the output values</span>
<span class="sd">        dictionary.</span>

<span class="sd">        Output values are then read by Soma-Workflow, and values are set in the</span>
<span class="sd">        downstream jobs which depend on these values.</span>

<span class="sd">        For this, &quot;parameters links&quot; have been added, to tell Soma-Workflow</span>
<span class="sd">        which input parameters should be replaced by output parameter values</span>
<span class="sd">        from an upstream job.</span>

<span class="sd">        param_links is an (optional) dict which specifies these links::</span>

<span class="sd">            {dest_job: {dest_param: [(source_job, param, &lt;function&gt;), ...]}}</span>

<span class="sd">        Such links de facto define new jobs dependencies, which are added to</span>
<span class="sd">        the dependencies manually specified.</span>

<span class="sd">        The optional function item is the name of a function that will be</span>
<span class="sd">        called to transform values from the source to the destination of the</span>
<span class="sd">        link at runtime. It is basically a string &quot;module.function&quot;, or a</span>
<span class="sd">        tuple for passing some arguments (as in partial):</span>
<span class="sd">        (&quot;module.function&quot;, 12, &quot;param&quot;). The function is called with</span>
<span class="sd">        additional arguments: parameter name, parameter value, destination</span>
<span class="sd">        parameter name, destination parameter current value. The destination</span>
<span class="sd">        parameter value is typically used to build / update a list in the</span>
<span class="sd">        destination job from a series of values in source jobs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jobs</span>
<span class="sd">        dependencies</span>
<span class="sd">        root_group</span>
<span class="sd">        disposal_timeout</span>
<span class="sd">        user_storage</span>
<span class="sd">        name</span>
<span class="sd">        env</span>
<span class="sd">        env_builder_code</span>
<span class="sd">        param_links</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Within Workflow constructor&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="n">jobs</span>
        <span class="k">if</span> <span class="n">dependencies</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">dependencies</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disposal_timeout</span> <span class="o">=</span> <span class="n">disposal_timeout</span>

        <span class="c1"># Groups</span>
        <span class="k">if</span> <span class="n">root_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_group</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span> <span class="o">=</span> <span class="n">root_group</span><span class="o">.</span><span class="n">elements</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span> <span class="o">=</span> <span class="n">root_group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">to_explore</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                    <span class="n">to_explore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">to_explore</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">to_explore</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                        <span class="n">to_explore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.root_group = self.jobs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># replace groups in deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__convert_group_dependencies</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env_builder_code</span> <span class="o">=</span> <span class="n">env_builder_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_links</span> <span class="o">=</span> <span class="n">param_links</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies_from_links</span><span class="p">()</span>

<div class="viewcode-block" id="Workflow.add_workflow">
<a class="viewcode-back" href="../../workflow_creation.html#client.Workflow.add_workflow">[docs]</a>
    <span class="k">def</span> <span class="nf">add_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">as_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Concatenates a workflow into the current one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        workflow: Workflow</span>
<span class="sd">            workflow to be added to self</span>
<span class="sd">        as_group: string (optional)</span>
<span class="sd">            if specified, the workflow will be added as a group with the given</span>
<span class="sd">            name</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        group or None</span>
<span class="sd">            if as_group is specified, the group created for the sub-workflow</span>
<span class="sd">            will be returned, otherwise the function returns None.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">+=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">+=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># assume set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_group</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">root_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">as_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">+=</span> <span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="n">workflow</span><span class="o">.</span><span class="n">groups</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span> <span class="o">+=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">root_group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">+=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">groups</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">param_links</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">param_links</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="c1"># self.env_builder_code ?</span>
        <span class="k">return</span> <span class="n">group</span></div>


<div class="viewcode-block" id="Workflow.add_dependencies">
<a class="viewcode-back" href="../../workflow_creation.html#client.Workflow.add_dependencies">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add additional dependencies in the workflow.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">+=</span> <span class="n">dependencies</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># assume set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__convert_group_dependencies</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span></div>


<div class="viewcode-block" id="Workflow.add_dependencies_from_links">
<a class="viewcode-back" href="../../workflow_creation.html#client.Workflow.add_dependencies_from_links">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dependencies_from_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Process parameters links and add missing jobs dependencies accordingly</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">current_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dest_job</span><span class="p">,</span> <span class="n">links</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_links</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">linkl</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linkl</span><span class="p">:</span>
                    <span class="n">deps</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest_job</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_deps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># deps as set</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_deps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">seq_attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;jobs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">,</span>
            <span class="s2">&quot;root_group&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groups&quot;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">seq_attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_attr</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Job</span><span class="p">)</span> <span class="ow">or</span>\
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Group</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attributs_equal</span><span class="p">(</span><span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span>\
                       <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attributs_equal</span><span class="p">(</span><span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">attributs_equal</span><span class="p">(</span><span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">other_attr</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">env</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_builder_code</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">env_builder_code</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_links</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">param_links</span>

<div class="viewcode-block" id="Workflow.to_dict">
<a class="viewcode-back" href="../../workflow_creation.html#client.Workflow.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The keys must be string to serialize with JSON.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">id_generator</span> <span class="o">=</span> <span class="n">IdGenerator</span><span class="p">()</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Job -&gt; id</span>

        <span class="n">wf_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">new_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">new_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
            <span class="n">job_ids</span><span class="p">[</span><span class="n">job</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_jobs</span>

        <span class="n">new_dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="ow">or</span> <span class="n">dep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown jobs in dependencies.&quot;</span><span class="p">)</span>
            <span class="n">new_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">job_ids</span><span class="p">[</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">job_ids</span><span class="p">[</span><span class="n">dep</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dependencies</span>

        <span class="n">new_links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dest_job</span><span class="p">,</span> <span class="n">links</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_links</span><span class="p">):</span>
            <span class="n">wdjob</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="n">dest_job</span><span class="p">]</span>
            <span class="n">wlinks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dest_par</span><span class="p">,</span> <span class="n">linkl</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linkl</span><span class="p">:</span>
                    <span class="n">wlinks</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dest_par</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">)</span> <span class="o">+</span> <span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">new_links</span><span class="p">[</span><span class="n">wdjob</span><span class="p">]</span> <span class="o">=</span> <span class="n">wlinks</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s1">&#39;param_links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_links</span>

        <span class="n">group_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">new_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
            <span class="n">group_ids</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_groups</span>

        <span class="n">new_root_group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">new_root_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                <span class="n">new_root_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown root group element.&quot;</span><span class="p">)</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;root_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_root_group</span>

        <span class="n">ser_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">group_ids</span><span class="p">):</span>
            <span class="n">ser_groups</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">)</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_groups</span>

        <span class="n">ser_jobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ser_barriers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">transfer_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># FileTransfer -&gt; id</span>
        <span class="n">shared_res_path_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># SharedResourcePath -&gt; id</span>
        <span class="n">temporary_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># TemporaryPath -&gt; id</span>
        <span class="n">option_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># OptionPath -&gt; id</span>
        <span class="k">for</span> <span class="n">job</span><span class="p">,</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">job_ids</span><span class="p">):</span>
            <span class="n">ser_jobs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">id_generator</span><span class="p">,</span>
                                                <span class="n">transfer_ids</span><span class="p">,</span>
                                                <span class="n">shared_res_path_ids</span><span class="p">,</span>
                                                <span class="n">temporary_ids</span><span class="p">,</span>
                                                <span class="n">option_ids</span><span class="p">)</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_jobs</span>

        <span class="n">ser_transfers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_transfer</span><span class="p">,</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">transfer_ids</span><span class="p">):</span>
            <span class="n">ser_transfers</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file_transfer</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_file_transfers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_transfers</span>

        <span class="n">ser_srp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">srp</span><span class="p">,</span> <span class="n">srp_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">shared_res_path_ids</span><span class="p">):</span>
            <span class="n">ser_srp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">srp_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">srp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_shared_res_paths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_srp</span>

        <span class="n">ser_tmp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tmpf</span><span class="p">,</span> <span class="n">tmp_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">temporary_ids</span><span class="p">):</span>
            <span class="n">ser_tmp</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tmpf</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_temporary_paths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_tmp</span>

        <span class="n">ser_opt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">optf</span><span class="p">,</span> <span class="n">opt_id</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">option_ids</span><span class="p">):</span>
            <span class="n">ser_opt</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">opt_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">optf</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">id_generator</span><span class="p">,</span>
                                                <span class="n">transfer_ids</span><span class="p">,</span>
                                                <span class="n">shared_res_path_ids</span><span class="p">,</span>
                                                <span class="n">temporary_ids</span><span class="p">,</span>
                                                <span class="n">option_ids</span><span class="p">)</span>
        <span class="n">wf_dict</span><span class="p">[</span><span class="s2">&quot;serialized_option_paths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser_opt</span>

        <span class="c1"># user_storage</span>
        <span class="n">user_storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_storage</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user_storage</span><span class="p">,</span> <span class="s1">&#39;to_dict&#39;</span><span class="p">):</span>
            <span class="n">user_storage</span> <span class="o">=</span> <span class="n">user_storage</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">wf_dict</span><span class="p">[</span><span class="s1">&#39;env&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_builder_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wf_dict</span><span class="p">[</span><span class="s1">&#39;env_builder_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_builder_code</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">):</span>
            <span class="n">wf_dict</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span>

        <span class="k">return</span> <span class="n">wf_dict</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># shared resource paths</span>
        <span class="n">serialized_srp</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_shared_res_paths&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">srp_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">srp_id</span><span class="p">,</span> <span class="n">srp_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_srp</span><span class="p">):</span>
            <span class="n">srp</span> <span class="o">=</span> <span class="n">SharedResourcePath</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">srp_d</span><span class="p">)</span>
            <span class="n">srp_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">srp_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">srp</span>

        <span class="c1"># file transfers</span>
        <span class="n">serialized_tr</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_file_transfers&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">tr_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tr_id</span><span class="p">,</span> <span class="n">tr_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_tr</span><span class="p">):</span>
            <span class="n">file_transfer</span> <span class="o">=</span> <span class="n">FileTransfer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">tr_d</span><span class="p">)</span>
            <span class="n">tr_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tr_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">file_transfer</span>

        <span class="c1"># file transfers</span>
        <span class="n">serialized_tmp</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_temporary_paths&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">tmp_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tmp_id</span><span class="p">,</span> <span class="n">tmp_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_tmp</span><span class="p">):</span>
            <span class="n">temp_file</span> <span class="o">=</span> <span class="n">TemporaryPath</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">)</span>
            <span class="n">tmp_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tmp_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">temp_file</span>

        <span class="c1"># option paths</span>
        <span class="n">serialized_opt</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_option_paths&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">opt_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">opt_id</span><span class="p">,</span> <span class="n">opt_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_opt</span><span class="p">):</span>
            <span class="n">opt_file</span> <span class="o">=</span> <span class="n">OptionPath</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">opt_d</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span> <span class="n">srp_from_ids</span><span class="p">,</span> <span class="n">tmp_from_ids</span><span class="p">,</span> <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">opt_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">opt_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">opt_file</span>

        <span class="c1"># jobs</span>
        <span class="n">serialized_jobs</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_jobs&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">job_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_jobs</span><span class="p">):</span>
            <span class="n">cls_name</span> <span class="o">=</span> <span class="n">job_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;soma_workflow.client_types.Job&quot;</span><span class="p">)</span>
            <span class="n">cls_mod</span> <span class="o">=</span> <span class="n">cls_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cls_mod</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">jcls</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">cls_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">cls_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">jcls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls_mod</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">jcls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">job_d</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span> <span class="n">srp_from_ids</span><span class="p">,</span>
                                 <span class="n">tmp_from_ids</span><span class="p">,</span> <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">job</span>

        <span class="c1"># barrier jobs</span>
        <span class="c1"># obsolete: barriers are now part of jobs definitions, but this helps</span>
        <span class="c1"># reloading older workflows.</span>
        <span class="n">serialized_jobs</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_barriers&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_d</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">serialized_jobs</span><span class="p">):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">BarrierJob</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">job_d</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span> <span class="n">srp_from_ids</span><span class="p">,</span> <span class="n">tmp_from_ids</span><span class="p">,</span> <span class="n">opt_from_ids</span><span class="p">)</span>
            <span class="n">job_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">job</span>

        <span class="n">jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">job_from_ids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># groups</span>
        <span class="n">serialized_groups</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serialized_groups&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">group_from_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">to_convert</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">serialized_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">converted_or_stuck</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">converted_or_stuck</span><span class="p">:</span>
            <span class="n">new_converted</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">to_convert</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">serialized_groups</span><span class="p">[</span><span class="n">group_id</span><span class="p">],</span>
                                        <span class="n">group_from_ids</span><span class="p">,</span>
                                        <span class="n">job_from_ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
                    <span class="n">group_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">group_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group</span>
            <span class="k">for</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">new_converted</span><span class="p">:</span>
                <span class="n">to_convert</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
            <span class="n">converted_or_stuck</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">to_convert</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">new_converted</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group_from_ids</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># WARNING, not used</span>

        <span class="c1"># root group</span>
        <span class="n">id_root_group</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;root_group&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">root_group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">id_root_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">group_from_ids</span><span class="p">:</span>
                <span class="n">root_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_from_ids</span><span class="p">[</span><span class="n">el_id</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">job_from_ids</span><span class="p">:</span>
                <span class="n">root_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_from_ids</span><span class="p">[</span><span class="n">el_id</span><span class="p">])</span>

        <span class="c1"># dependencies</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">id_dependencies</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">id_dep</span> <span class="ow">in</span> <span class="n">id_dependencies</span><span class="p">:</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_from_ids</span><span class="p">[</span><span class="n">id_dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">job_from_ids</span><span class="p">[</span><span class="n">id_dep</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="c1"># param links</span>
        <span class="n">param_links</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">id_links</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;param_links&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">dest_job</span><span class="p">,</span> <span class="n">links</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">id_links</span><span class="p">):</span>
            <span class="n">ddest_job</span> <span class="o">=</span> <span class="n">job_from_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dest_job</span><span class="p">)]</span>
            <span class="n">dlinks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">lname</span><span class="p">,</span> <span class="n">linkl</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
                <span class="n">dlinkl</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linkl</span><span class="p">:</span>
                    <span class="n">dsrc_job</span> <span class="o">=</span> <span class="n">job_from_ids</span><span class="p">[</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">dlinkl</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dsrc_job</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="n">dlinks</span><span class="p">[</span><span class="n">lname</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlinkl</span>
            <span class="n">param_links</span><span class="p">[</span><span class="n">ddest_job</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlinks</span>

        <span class="c1"># user storage, TODO: handle objects in it</span>
        <span class="n">user_storage</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_storage&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">env_builder_code</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;env_builder_code&#39;</span><span class="p">)</span>

        <span class="n">workflow</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span>
                       <span class="n">dependencies</span><span class="p">,</span>
                       <span class="n">root_group</span><span class="o">=</span><span class="n">root_group</span><span class="p">,</span>
                       <span class="n">user_storage</span><span class="o">=</span><span class="n">user_storage</span><span class="p">,</span>
                       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                       <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                       <span class="n">env_builder_code</span><span class="o">=</span><span class="n">env_builder_code</span><span class="p">,</span>
                       <span class="n">param_links</span><span class="o">=</span><span class="n">param_links</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">workflow</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># filter out some instance attributes which should / can not be pickled</span>
        <span class="n">no_picke</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_do_not_pickle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_picke</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_dict</span>
        <span class="n">copied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">no_picke</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">copied</span><span class="p">:</span>
                    <span class="n">state_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
                    <span class="n">copied</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">state_dict</span>

    <span class="k">def</span> <span class="nf">__group_hubs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Replace a group with a BarrierJob pair for inputs and ouputs).</span>
<span class="sd">        All jobs inside the group depends on its input hub, and the output hub</span>
<span class="sd">        depends on all jobs in the group</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ghubs</span> <span class="o">=</span> <span class="n">group_to_hub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ghubs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ghubs</span>
        <span class="n">ghubs</span> <span class="o">=</span> <span class="p">(</span><span class="n">BarrierJob</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_input&#39;</span><span class="p">),</span>
                 <span class="n">BarrierJob</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_output&#39;</span><span class="p">))</span>
        <span class="n">group_to_hub</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">ghubs</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ghubs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ghubs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">ghubs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ghubs</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">ghubs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ghubs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unsupported jobs list type: </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ghubs</span>

    <span class="k">def</span> <span class="nf">__group_hubs_recurs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Replace a group with a BarrierJob pair for inputs and ouputs).</span>
<span class="sd">        Same as __group_hubs() but also create hubs for sub-groups in group</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="n">ghubs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ghubs_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_hubs</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ghubs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ghubs</span> <span class="o">=</span> <span class="n">ghubs_tmp</span>
            <span class="n">groups</span> <span class="o">+=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">elements</span>
                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Group</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ghubs</span>

    <span class="k">def</span> <span class="nf">__make_group_hubs_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Build and return intra-group dependencies list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">in_hub</span><span class="p">,</span> <span class="n">out_hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_hubs</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>  <span class="c1"># depends on a sub-group</span>
                <span class="n">sub_hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_hubs</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
                <span class="c1"># TODO: check that these dependencies are not already here</span>
                <span class="c1"># (directly or indirectly)</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">in_hub</span><span class="p">,</span> <span class="n">sub_hub</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sub_hub</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_hub</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># regular job</span>
                <span class="c1"># TODO: check that these dependencies are not already here</span>
                <span class="c1"># (directly or indirectly)</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">in_hub</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">out_hub</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dependencies</span>

    <span class="k">def</span> <span class="nf">__convert_group_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Converts dependencies using groups into barrier jobs when needed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dependencies: list, tuple, set (optional)</span>
<span class="sd">            dependencies list to check. If not specified, chek all dependencies</span>
<span class="sd">            in the workflow. When specified, the dependencies list should be</span>
<span class="sd">            a subset of the workflow dependencies (all must exist in</span>
<span class="sd">            self.dependencies)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_deps_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_to_hub</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">deps_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
            <span class="n">reindex</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reindex</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">dependency</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">Group</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">reindex</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
                <span class="n">deps_to_remove</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>  <span class="c1"># reverse order index list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deps_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                <span class="c1"># a group is replaced with a BarrierJob pair for inputs and</span>
                <span class="c1"># ouputs)</span>
                <span class="n">ghubs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_hubs_recurs</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
                <span class="n">j1</span> <span class="o">=</span> <span class="n">ghubs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># replace input group with the group ouput hub</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
                <span class="c1"># a group is replaced with a BarrierJob pair for inputs and</span>
                <span class="c1"># ouputs)</span>
                <span class="n">ghubs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__group_hubs_recurs</span><span class="p">(</span><span class="n">j2</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
                <span class="n">j2</span> <span class="o">=</span> <span class="n">ghubs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># replace output group with the group input hub</span>
            <span class="n">new_deps_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">))</span>
        <span class="c1"># rebuild intra-group links</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">ghubs</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">group_to_hub</span><span class="p">):</span>
            <span class="n">new_deps_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_group_hubs_deps</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">group_to_hub</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">deps_to_remove</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_deps_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c1"># remove converted dependencies</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">deps_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># add new ones</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">+=</span> <span class="n">new_deps_list</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
            <span class="c1"># remove converted dependencies</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">deps_to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># add new ones</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">+=</span> <span class="n">new_deps_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unsupported dependencies type: </span><span class="si">%s</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)))</span></div>



<div class="viewcode-block" id="Group">
<a class="viewcode-back" href="../../workflow_creation.html#client.Group">[docs]</a>
<span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Hierarchical structure of a workflow.</span>

<span class="sd">    .. note:</span>
<span class="sd">      It only has a displaying role and does not have any impact on the workflow</span>
<span class="sd">      execution.</span>

<span class="sd">    **elements**: *sequence of Job and/or Group*</span>
<span class="sd">      The elements (Job or Group) belonging to the group.</span>

<span class="sd">    **name**: *string*</span>
<span class="sd">      Name of the Group which will be displayed in the GUI.</span>

<span class="sd">    **user_storage**: *picklable object*</span>
<span class="sd">      For the user needs, any small and picklable object can be stored here.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># string</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of Job and/or Group</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># any small and picklable object needed by the user</span>
    <span class="n">user_storage</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">user_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        @type  elements: sequence of Job and/or Group</span>
<span class="sd">        @param elements: the elements belonging to the group</span>
<span class="sd">        @type  name: string</span>
<span class="sd">        @param name: name of the group</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attributs_equal</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">):</span>
        <span class="n">group_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">group_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">new_gp_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">:</span>
                <span class="n">new_gp_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                <span class="n">new_gp_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown group element.&quot;</span><span class="p">)</span>
        <span class="n">group_dict</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_gp_elements</span>
        <span class="k">return</span> <span class="n">group_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">group_from_ids</span><span class="p">,</span> <span class="n">job_from_ids</span><span class="p">):</span>
        <span class="n">id_elements</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">]</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">id_elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">job_from_ids</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_from_ids</span><span class="p">[</span><span class="n">el_id</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">el_id</span> <span class="ow">in</span> <span class="n">group_from_ids</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_from_ids</span><span class="p">[</span><span class="n">el_id</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group</span></div>



<span class="k">class</span> <span class="nc">SpecialPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Abstract base class for special file or directory path, which needs specific handling in the engine.</span>

<span class="sd">    FileTransfer, TemporaryPath, and SharedResourcePath are SpecialPath.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pattern</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">referent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="k">else</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span>
        <span class="n">res</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iadd__</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>


<div class="viewcode-block" id="FileTransfer">
<a class="viewcode-back" href="../../workflow_creation.html#client.FileTransfer">[docs]</a>
<span class="k">class</span> <span class="nc">FileTransfer</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    File/directory transfer representation</span>

<span class="sd">    .. note::</span>
<span class="sd">      FileTransfers objects are only required if the user and computing resources</span>
<span class="sd">      have a separate file system.</span>

<span class="sd">    **client_path**: *string*</span>
<span class="sd">      Path of the file or directory on the user&#39;s file system.</span>

<span class="sd">    **initial_status**: *constants.FILES_DO_NOT_EXIST or constants.FILES_ON_CLIENT*</span>
<span class="sd">      * constants.FILES_ON_CLIENT for workflow input files</span>
<span class="sd">        The file(s) will need to be transfered on the computing resource side</span>
<span class="sd">      * constants.FILES_DO_NOT_EXIST for workflow output files</span>
<span class="sd">        The file(s) will be created by a job on the computing resource side.</span>

<span class="sd">    **client_paths**: *sequence of string*</span>
<span class="sd">      Sequence of path. Files to transfer if the FileTransfers concerns a file</span>
<span class="sd">      series or if the file format involves several associated files or</span>
<span class="sd">      directories (see the note below).</span>

<span class="sd">    **name**: *string*</span>
<span class="sd">      Name of the FileTransfer which will be displayed in the GUI.</span>
<span class="sd">      Default: client_path + &quot;transfer&quot;</span>

<span class="sd">    When a file is transfered via a FileTransfer, the Job it is used in has to be</span>
<span class="sd">    built using the FileTransfer object in place of the file name in the command</span>
<span class="sd">    list. The FileTransfer object has also to be on the referenced_input_files</span>
<span class="sd">    or referenced_output_files lists in Job constructor.</span>

<span class="sd">    .. note::</span>
<span class="sd">      Use client_paths if the transfer involves several associated files and/or</span>
<span class="sd">      directories. Examples:</span>

<span class="sd">        * file series</span>
<span class="sd">        * file format associating several file and/or directories</span>
<span class="sd">          (ex: a SPM images are stored in 2 associated files: .img and .hdr)</span>
<span class="sd">          In this case, set client_path to one the files (ex: .img) and</span>
<span class="sd">          client_paths contains all the files (ex: .img and .hdr files)</span>

<span class="sd">      In other cases (1 file or 1 directory) the client_paths must be set to</span>
<span class="sd">      None.</span>

<span class="sd">      When client_paths is not None, the server-side handling of paths is</span>
<span class="sd">      different: the server directory is used istead of files. This has slight</span>
<span class="sd">      consequences on the behaviour of the workflow:</span>

<span class="sd">      * in soma-workflow 2.6 and earlier, the commandline will be using the</span>
<span class="sd">        directory instead of a file name, which is often not what you expect.</span>
<span class="sd">      * in soma-workflow 2.7 and later, the commandline will be using the</span>
<span class="sd">        main file name (client_path) translated to the server location. This is</span>
<span class="sd">        more probably what is expected.</span>
<span class="sd">      * in any case it is possible to specify the commandline path using a</span>
<span class="sd">        tuple as commandline argument:</span>
<span class="sd">        ::</span>

<span class="sd">          myfile = FileTransfer(is_input=True, client_path=&#39;/home/bubu/plof.nii&#39;,</span>
<span class="sd">              client_paths=[&#39;/home/bubu/plof.nii&#39;, &#39;/home/bubu/plof.nii.minf&#39;])</span>
<span class="sd">          # job1 will work with SWF &gt;= 2.7, not in 2.6</span>
<span class="sd">          job1 = Job(command=[&#39;AimsFileInfo&#39;, myfile],</span>
<span class="sd">              referenced_input_files=[myfile])</span>
<span class="sd">          # job2 will use &lt;engine_path&gt;/plof.nii as input</span>
<span class="sd">          job2 = Job(command=[&#39;AimsFileInfo&#39;, (myfile, &#39;plof.nii&#39;)],</span>
<span class="sd">              referenced_input_files=[myfile]))</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># string</span>
    <span class="n">_client_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sequence of string</span>
    <span class="n">_client_paths</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># constants.FILES_DO_NOT_EXIST constants.FILES_ON_CLIENT</span>
    <span class="n">_initial_status</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># int (hours)</span>
    <span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">is_input</span><span class="p">,</span>
                 <span class="n">client_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disposal_timeout</span><span class="o">=</span><span class="mi">168</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">client_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_input: bool</span>
<span class="sd">            specifies if the files have to be transferred from the client before</span>
<span class="sd">            job execution, or back to the client after execution.</span>
<span class="sd">        client_path: string</span>
<span class="sd">            main file name</span>
<span class="sd">        disposal_timeout: int (optional)</span>
<span class="sd">            default: 168</span>
<span class="sd">        name: string (optional)</span>
<span class="sd">            name displayed in the GUI</span>
<span class="sd">        client_paths: list (optional)</span>
<span class="sd">            when several files are involved</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">client_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                    <span class="ow">or</span> <span class="n">client_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;FileTransfer as copy constructor &#39;</span>
                                <span class="s1">&#39;should have only one argument&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">FileTransfer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">client_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;FileTransfer.__init__ takes at least &#39;</span>
                            <span class="s1">&#39;3 arguments&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileTransfer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">ft_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ft_name</span> <span class="o">=</span> <span class="n">client_path</span> <span class="o">+</span> <span class="s2">&quot;transfer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ft_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_path</span> <span class="o">=</span> <span class="n">client_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="n">disposal_timeout</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_paths</span> <span class="o">=</span> <span class="n">client_paths</span>

        <span class="k">if</span> <span class="n">is_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial_status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initial_status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_DO_NOT_EXIST</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_client_path</span>

    <span class="nd">@client_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">client_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_client_path</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_client_paths</span>

    <span class="nd">@client_paths</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">client_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_client_paths</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">initial_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_initial_status</span>

    <span class="nd">@initial_status</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">initial_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_initial_status</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span>

    <span class="nd">@disposal_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;client_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;client_paths&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initial_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other_attr</span> <span class="o">==</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">transfer_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;client_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;client_paths&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initial_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">transfer_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transfer_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">transfer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">is_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">client_path</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">transfer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transfer</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">client_path</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span></div>



<div class="viewcode-block" id="SharedResourcePath">
<a class="viewcode-back" href="../../workflow_creation.html#client.SharedResourcePath">[docs]</a>
<span class="k">class</span> <span class="nc">SharedResourcePath</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Representation of path which is valid on either user&#39;s or computing resource</span>
<span class="sd">    file system.</span>

<span class="sd">    .. note::</span>
<span class="sd">      SharedResourcePath objects are only required if the user and computing</span>
<span class="sd">      resources have a separate file system.</span>

<span class="sd">    **namespace**: *string*</span>
<span class="sd">      Namespace for the path. That way several applications can use the same</span>
<span class="sd">      identifiers without risk.</span>

<span class="sd">    **uuid**: *string*</span>
<span class="sd">      Identifier of the absolute path.</span>

<span class="sd">    **relative_path**: *string*</span>
<span class="sd">      Relative path of the file if the absolute path is a directory path.</span>

<span class="sd">    .. warning::</span>
<span class="sd">      The namespace and uuid must exist in the translations files configured on</span>
<span class="sd">      the computing resource side.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_relative_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_namespace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_uuid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">relative_path</span><span class="p">,</span>
                 <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disposal_timeout</span><span class="o">=</span><span class="mi">168</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;SharedResourcePath as copy constructor &#39;</span>
                                <span class="s1">&#39;should have only one argument&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SharedResourcePath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;SharedResourcePath.__init__ takes at least &#39;</span>
                            <span class="s1">&#39;4 arguments&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SharedResourcePath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_path</span> <span class="o">=</span> <span class="n">relative_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disposal_timout</span> <span class="o">=</span> <span class="n">disposal_timeout</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">relative_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_relative_path</span>

    <span class="nd">@relative_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">relative_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_relative_path</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_namespace</span>

    <span class="nd">@namespace</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_uuid</span>

    <span class="nd">@uuid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span>

    <span class="nd">@disposal_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;relative_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;namespace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">other_attr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">srp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;relative_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;namespace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uuid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">srp_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srp_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">shared_res_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">relative_path</span><span class="o">=</span><span class="s2">&quot;toto&quot;</span><span class="p">,</span>
                              <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;toto&quot;</span><span class="p">,</span>
                              <span class="n">uuid</span><span class="o">=</span><span class="s2">&quot;toto&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">shared_res_path</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shared_res_path</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">ref</span><span class="o">.</span><span class="n">relative_path</span><span class="p">))</span></div>



<div class="viewcode-block" id="TemporaryPath">
<a class="viewcode-back" href="../../workflow_creation.html#client.TemporaryPath">[docs]</a>
<span class="k">class</span> <span class="nc">TemporaryPath</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Temporary file representation. This temporary file will never exist on client</span>
<span class="sd">    side: its filename will be created on server side, used during the workflow</span>
<span class="sd">    execution, and removed when not used any longer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    is_directory: bool (optional)</span>
<span class="sd">        default: False</span>
<span class="sd">    disposal_timeout: int (optional)</span>
<span class="sd">        default: 168</span>
<span class="sd">    name: string (optional)</span>
<span class="sd">        name for the TemporaryPath object, displayed in GUI for instance</span>
<span class="sd">    suffix: string (optional)</span>
<span class="sd">        suffix (typically: extension) applied to the generated file name</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># bool</span>
    <span class="n">_is_directory</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># int (hours)</span>
    <span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string</span>
    <span class="n">_suffix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">is_directory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">disposal_timeout</span><span class="o">=</span><span class="mi">168</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;TemporaryPath as copy constructor should &#39;</span>
                                <span class="s1">&#39;have only one argument&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">TemporaryPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_directory</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemporaryPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_directory</span> <span class="o">=</span> <span class="n">is_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="n">disposal_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suffix</span> <span class="o">=</span> <span class="n">suffix</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;temporary&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_is_directory</span>

    <span class="nd">@is_directory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">is_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_is_directory</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span>

    <span class="nd">@disposal_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">disposal_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_disposal_timeout</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_suffix</span>

    <span class="nd">@suffix</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_suffix</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;is_directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">other_attr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">srp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;is_directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">srp_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srp_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">is_directory</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_directory&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">disposal_timeout</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;disposal_timeout&quot;</span><span class="p">,</span> <span class="mi">168</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">is_directory</span><span class="o">=</span><span class="n">is_directory</span><span class="p">,</span>
                        <span class="n">disposal_timeout</span><span class="o">=</span><span class="n">disposal_timeout</span><span class="p">,</span>
                        <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_file</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>



<span class="k">class</span> <span class="nc">OptionPath</span><span class="p">(</span><span class="n">SpecialPath</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    File with reading or writing parameters given through a URI (or any</span>
<span class="sd">    other suffix system). The file can be passed as a string or as a</span>
<span class="sd">    SpecialPath object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent_path : :obj:`str` or :obj:`SpecialPath`</span>
<span class="sd">        Path to the input file. If it is a :obj:`FileTransfer` or</span>
<span class="sd">        :obj:`TemporayPath`, this parent path should be added to</span>
<span class="sd">        the Job&#39;s referenced_input_files or referenced_output_files.</span>
<span class="sd">    uri : :obj:`str` or :obj:`dict`</span>
<span class="sd">        * If the provided URI is a string, it is tored as is and will be</span>
<span class="sd">        added at the end of the path when the server-side command is</span>
<span class="sd">        generated. A URI is of the form &#39;?option1=value1&amp;option2=value2&#39;.</span>
<span class="sd">        However, since the provided `uri` is untouched, any other option</span>
<span class="sd">        passing system can be used.</span>
<span class="sd">        * If the provided URI is a dictionary, it is converted to a URI</span>
<span class="sd">        string. Each key is considered an option name, mapped to its</span>
<span class="sd">        associated value.</span>
<span class="sd">    name : :obj:`str` (optional)</span>
<span class="sd">        Name of the path. If not provided, the full client-side path + URI is</span>
<span class="sd">        used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_parent_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_parent_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_uri</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># copy constructor</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">OptionPath</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;OptionPath as copy constructor should &#39;</span>
                                <span class="s1">&#39;have only one argument&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">OptionPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent_path</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># normal constructor</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OptionPath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">SpecialPath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_path</span> <span class="o">=</span> <span class="n">parent_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">iteritems</span>
            <span class="n">build_uri</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
                <span class="n">build_uri</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span>
            <span class="n">build_uri</span> <span class="o">=</span> <span class="n">build_uri</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">build_uri</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;parent_path&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_path</span>

    <span class="nd">@parent_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parent_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SpecialPath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_path</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_uri</span>

    <span class="nd">@uri</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_uri</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referent</span><span class="p">()</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">attributs_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;parent_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parent_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uri&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="n">other_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">other_attr</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">id_generator</span><span class="p">,</span>
                <span class="n">transfer_ids</span><span class="p">,</span>
                <span class="n">shared_res_path_id</span><span class="p">,</span>
                <span class="n">tmp_ids</span><span class="p">,</span>
                <span class="n">opt_ids</span><span class="p">):</span>
        <span class="n">opt_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;parent_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parent_path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uri&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s2">&quot;parent_path&quot;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;parent_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                <span class="n">opt_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">),</span>
                                                      <span class="n">id_generator</span><span class="p">,</span>
                                                      <span class="n">transfer_ids</span><span class="p">,</span>
                                                      <span class="n">shared_res_path_id</span><span class="p">,</span>
                                                      <span class="n">tmp_ids</span><span class="p">,</span>
                                                      <span class="n">opt_ids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt_dict</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">opt_dict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
                  <span class="n">tr_from_ids</span><span class="p">,</span>
                  <span class="n">srp_from_ids</span><span class="p">,</span>
                  <span class="n">tmp_from_ids</span><span class="p">,</span>
                  <span class="n">opt_from_ids</span><span class="p">):</span>
        <span class="n">parent_type</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_type&quot;</span><span class="p">,</span> <span class="s2">&quot;str&quot;</span><span class="p">)</span>
        <span class="n">parent_path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_type</span> <span class="o">!=</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
            <span class="n">parent_path</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span>
                                            <span class="n">tr_from_ids</span><span class="p">,</span>
                                            <span class="n">srp_from_ids</span><span class="p">,</span>
                                            <span class="n">tmp_from_ids</span><span class="p">,</span>
                                            <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">parent_path</span><span class="o">=</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;parent_path&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_type&quot;</span><span class="p">,</span> <span class="s2">&quot;uri&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_file</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_path</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">IdGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">generate_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">current_id</span>


<span class="k">def</span> <span class="nf">to_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                    <span class="n">id_generator</span><span class="p">,</span>
                    <span class="n">transfer_ids</span><span class="p">,</span>
                    <span class="n">shared_res_path_ids</span><span class="p">,</span>
                    <span class="n">tmp_ids</span><span class="p">,</span>
                    <span class="n">opt_ids</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">FileTransfer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">transfer_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">transfer_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">transfer_ids</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">SharedResourcePath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">shared_res_path_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">shared_res_path_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">shared_res_path_ids</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">TemporaryPath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">tmp_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">tmp_ids</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">OptionPath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">opt_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">opt_ids</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">id_generator</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
            <span class="n">opt_ids</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">list_to_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                                    <span class="n">id_generator</span><span class="p">,</span>
                                    <span class="n">transfer_ids</span><span class="p">,</span>
                                    <span class="n">shared_res_path_ids</span><span class="p">,</span>
                                    <span class="n">tmp_ids</span><span class="p">,</span>
                                    <span class="n">opt_ids</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_to_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                                          <span class="n">id_generator</span><span class="p">,</span>
                                          <span class="n">transfer_ids</span><span class="p">,</span>
                                          <span class="n">shared_res_path_ids</span><span class="p">,</span>
                                          <span class="n">tmp_ids</span><span class="p">,</span>
                                          <span class="n">opt_ids</span><span class="p">))</span>
        <span class="c1"># return [&quot;soma-workflow-tuple&quot;,</span>
                <span class="c1"># to_serializable(element[0],</span>
                                <span class="c1"># id_generator,</span>
                                <span class="c1"># transfer_ids,</span>
                                <span class="c1"># shared_res_path_ids,</span>
                                <span class="c1"># tmp_ids,</span>
                                <span class="c1"># opt_ids),</span>
                <span class="c1"># element[1]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">element</span>


<span class="k">def</span> <span class="nf">from_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                      <span class="n">tr_from_ids</span><span class="p">,</span>
                      <span class="n">srp_from_ids</span><span class="p">,</span>
                      <span class="n">tmp_from_ids</span><span class="p">,</span>
                      <span class="n">opt_from_ids</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;soma-workflow-tuple&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">from_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">tr_from_ids</span><span class="p">,</span>
                                      <span class="n">srp_from_ids</span><span class="p">,</span>
                                      <span class="n">tmp_from_ids</span><span class="p">,</span>
                                      <span class="n">opt_from_ids</span><span class="p">),</span>
                    <span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span> <span class="n">srp_from_ids</span><span class="p">,</span>
                                          <span class="n">tmp_from_ids</span><span class="p">,</span> <span class="n">opt_from_ids</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;&lt;id&gt;&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">el</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tr_from_ids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tr_from_ids</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">srp_from_ids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">srp_from_ids</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tmp_from_ids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tmp_from_ids</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">opt_from_ids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">opt_from_ids</span><span class="p">[</span><span class="n">el</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">list_from_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">tr_from_ids</span><span class="p">,</span> <span class="n">srp_from_ids</span><span class="p">,</span>
                                       <span class="n">tmp_from_ids</span><span class="p">,</span> <span class="n">opt_from_ids</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">element</span>


<span class="k">def</span> <span class="nf">list_to_serializable</span><span class="p">(</span><span class="n">list_to_convert</span><span class="p">,</span>
                         <span class="n">id_generator</span><span class="p">,</span>
                         <span class="n">transfer_ids</span><span class="p">,</span>
                         <span class="n">shared_res_path_ids</span><span class="p">,</span>
                         <span class="n">tmp_ids</span><span class="p">,</span>
                         <span class="n">opt_ids</span><span class="p">):</span>
    <span class="n">ser_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">list_to_convert</span><span class="p">:</span>
        <span class="n">ser_element</span> <span class="o">=</span> <span class="n">to_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                                      <span class="n">id_generator</span><span class="p">,</span>
                                      <span class="n">transfer_ids</span><span class="p">,</span>
                                      <span class="n">shared_res_path_ids</span><span class="p">,</span>
                                      <span class="n">tmp_ids</span><span class="p">,</span>
                                      <span class="n">opt_ids</span><span class="p">)</span>
        <span class="n">ser_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ser_element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ser_list</span>


<span class="k">def</span> <span class="nf">list_from_serializable</span><span class="p">(</span><span class="n">list_to_convert</span><span class="p">,</span>
                           <span class="n">tr_from_ids</span><span class="p">,</span>
                           <span class="n">srp_from_ids</span><span class="p">,</span>
                           <span class="n">tmp_from_ids</span><span class="p">,</span>
                           <span class="n">opt_from_ids</span><span class="p">):</span>
    <span class="n">us_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">list_to_convert</span><span class="p">:</span>
        <span class="n">us_element</span> <span class="o">=</span> <span class="n">from_serializable</span><span class="p">(</span><span class="n">element</span><span class="p">,</span>
                                       <span class="n">tr_from_ids</span><span class="p">,</span>
                                       <span class="n">srp_from_ids</span><span class="p">,</span>
                                       <span class="n">tmp_from_ids</span><span class="p">,</span>
                                       <span class="n">opt_from_ids</span><span class="p">)</span>
        <span class="n">us_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">us_element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">us_list</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo_white_small.png" alt="Logo"/>
            </a></p>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">soma-workflow version 3.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">soma_workflow.client_types</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2011-2021 CEA, Neurospin, France, CATI, France.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>